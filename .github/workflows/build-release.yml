name: Build Distro ISO

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            - name: Install Buildroot dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential gcc g++ make cpio unzip rsync bc file \
                    libncurses5-dev libncursesw5-dev wget python3

            - name: Cache Buildroot download directory
              uses: actions/cache@v4
              with:
                  path: dl
                  key: ${{ runner.os }}-buildroot-dl
                  restore-keys: |
                      ${{ runner.os }}-buildroot-dl

            - name: Build (using repo root as Buildroot)
              run: |
                  # You already committed the .config, so we skip defconfig.
                  make

            - name: Find ISO
              id: findiso
              run: |
                  ISO_PATH=$(find output/images -name "*.iso" | head -n 1)
                  if [ -z "$ISO_PATH" ]; then
                    echo "No ISO found in output/images"
                    exit 1
                  fi
                  echo "iso=$ISO_PATH" >> "$GITHUB_OUTPUT"

            - name: Upload ISO to Release
              uses: softprops/action-gh-release@v2
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  files: ${{ steps.findiso.outputs.iso }}
